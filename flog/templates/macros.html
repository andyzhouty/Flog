{#
Copyright (c) 2020 Andy Zhou
MIT License
#}
{% macro static_file(type, filename_or_url, local=True, alt=None, width=None, height=None) %}
    {% if local -%}
        {% set filename_or_url = url_for('static', filename=filename_or_url) %}
    {%- endif %}
    {% if type == 'css' -%}
        <link rel="stylesheet" href="{{ filename_or_url }}">
    {% elif type == 'js' -%}
        <script src="{{ filename_or_url }}"></script>
    {% elif type == 'icon' -%}
        <link rel="icon" href="{{ filename_or_url }}">
    {% elif type == "svg" -%}
        <img src="{{ filename_or_url }}"
             type="image/svg+xml"
             {% if width %}width="{{ width }}"{% endif %}
             {% if height %}height="{{ height }}"{% endif %}
             class="pi-icon">
    {%- endif %}
{% endmacro %}

{% macro render_timestamp(timestamp) %}
    <span>{{ moment(timestamp).fromNow(refresh=True) }}</span>
{% endmacro %}

{% macro role_of(user) %}
    {{ _("User") }}
{% endmacro %}

{% macro render_user_role(user) %}
    <span class="text-muted">
        {{ user.username }}
    </span>
{% endmacro %}

{% macro level_badge(user) %}
    <span class="level-badge">
        <img src="{{ user.level_badge_link() }}" alt="level-badge" style="margin:.5em;">
    </span>
{% endmacro %}

{% macro coin_script() %}
    <script>
        function coins_loading(id) {
            let target = document.getElementById("btn-post-" + id)
            target.innerHTML = '<svg class="animate-spin ml-1 mr-3 my-1 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">\n<circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\n<path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\n</svg><span class="text-sm my-1">Coining...</span>'
        }
        function coin(id, coins) {
            div = document.getElementById("btn-post-" + id)
            content = div.innerHTML
            function back(delay = 1.5) {
                setTimeout(() => {
                    div.innerHTML = content
                }, delay * 1000)
            }
            coins_loading(id=id)
            axios({
                method: "post",
                url: "/ajax/post/" + id + "/coin/" + coins + "/",
                headers: {
                    "Accept": "application/json",
                },
                timeout: 30000,
                validateStatus: function (status) {
                    return ([200, 400, 500].indexOf(status) + 1) ? true : false
                },
            }).catch(error => {
                if (error.request) {
                    div.innerHTML = '<span class="text-yellow-500 dark:text-yellow-400 px-2 py-1">Request time out.</span>'
                    back()
                } else {
                    div.innerHTML = '<span class="text-red-500 dark:text-red-400 px-2 py-1">' + error.message + '</span>'
                    back()
                }
            }).then(function (response) {
                if (response.status == 200) {
                    div.innerHTML = '<span class="text-green-500 dark:text-green-400 px-2 py-1 text-sm">Success!</span>'
                } else if (response.status == 500) {
                    div.innerHTML = '<span class="text-red-500 dark:text-red-400 px-2 py-1 text-sm">Something went wrong.</span>'
                    back()
                } else {
                    div.innerHTML = '<span class="text-red-500 dark:text-red-400 px-2 py-1 text-sm">' + response.data.message + '</span>'
                    back()
                }
            })
        }
    </script>
{% endmacro %}


{% macro collect_script() %}
    <script>
        function collect_loading(id) {
            let target = document.getElementById("btn-collect-" + id)
            let target$ = $("#btn-collect-" + id)
            target$.addClass("animate-pulse")
            target.setAttribute("href", "javascript:void(0)")
            target.innerHTML = 'Hang on...'
        }
        function collect(id) {
            let target = document.getElementById("btn-collect-" + id)
            let target$ = $("#btn-collect-" + id)
            collect_loading(id=id)
            axios({
                method: "post",
                url: "/ajax/post/" + id + "/collect/",
                headers: {
                    "Accept": "application/json",
                },
                timeout: 30000,
                validateStatus: function (status) {
                    return ([200, 400].indexOf(status) + 1) ? true : false
                },
            }).catch(error => {
                if (error.request) {
                    alert("Collecting failed: Request Time Out.")
                    target.innerHTML = ('<i class="bi bi-star"></i>&nbsp;{{ _("Collect") }}')
                    target.setAttribute("href", "javascript:collect(" + id + ")")
                } else {
                    alert(error.message)
                }
            }).then(function (response) {
                if (response.status == 200) {
                    target.innerHTML = ('<i class="bi bi-star-fill"></i>&nbsp;{{ _("Uncollect") }}')
                    target.setAttribute("href", "javascript:uncollect(" + id + ")")
                    target$.removeClass("btn-inactivated")
                    target$.addClass("btn-activated")
                } else if (response.status == 400) {
                    target.innerHTML = ('<i class="bi bi-star"></i>&nbsp;{{ _("Collect") }}')
                    target.setAttribute("href", "javascript:collect(" + id + ")")
                } else {
                    alert("Collecting: failed: Something went wrong with our server.")
                }
            })
            target$.removeClass("animate-pulse")
        }
        function uncollect(id) {
            let target = document.getElementById("btn-collect-" + id)
            let target$ = $("#btn-collect-" + id)
            collect_loading(id=id)
            axios({
                method: "post",
                url: "/ajax/post/" + id + "/uncollect/",
                headers: {
                    "Accept": "application/json",
                },
                timeout: 30000,
                validateStatus: function (status) {
                    return ([200, 400].indexOf(status) + 1) ? true : false
                },
            }).catch(error => {
                if (error.request) {
                    alert("Collecting failed: Request Time Out.")
                    target.innerHTML = ('<i class="bi bi-star-fill"></i>&nbsp;{{ _("Uncollect") }}')
                    target.setAttribute("href", "javascript:uncollect(" + id + ")")
                } else {
                    alert(error.message)
                }
            }).then(function (response) {
                if (response.status == 200) {
                    target$.removeClass("btn-activated")
                    target$.addClass("btn-inactivated")
                    target.innerHTML = ('<i class="bi bi-star"></i>&nbsp;{{ _("Collect") }}')
                    target.setAttribute("href", "javascript:collect(" + id + ")")
                } else if (response.status == 400) {
                    target.innerHTML = ('<i class="bi bi-star-fill"></i>&nbsp;{{ _("Unollect") }}')
                    target.setAttribute("href", "javascript:uncollect(" + id + ")")
                } else {
                    alert("Collecting: failed: Something went wrong with our server.")
                }
            })
            target$.removeClass("animate-pulse")
        }
    </script>
{% endmacro %}

{% macro post_actions(post, can_edit=True, can_delete=True, show_collectors=None, collectors=0) %}
    {% if current_user.is_authenticated and post.title != post.author.username %}
        <div class="flex justify-start items-center my-2">
            <div id="btn-post-{{ post.id }}" class="flex bg-gray-100 dark:bg-gray-600 py-1 px-2 rounded-md"
                style="
                    transition: width 2s !important;
                    -webkit-transition: width 2s !important;
                    -moz-transition: width 2s !important;
                    -o-transition: width 2s !important;">
                {% if post.author == current_user %}
                    <p class="rounded-sm px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 text-sm mr-3 flex" href="javascript:void(0)">
                        <img src="{{ url_for('static', filename='svg/pi.svg') }}" class="h-5 w-5 mx-1">
                        {{ post.coins }}
                    </p>
                {% else %}
                    {% if not post in current_user.coined_posts -%}
                        <p class="rounded-sm px-2 py-1 text-gray-900 dark:text-gray-100 hover:text-gray-900 dark:hover:text-gray-100 text-sm mr-3 flex">
                            <img src="{{ url_for('static', filename='svg/pi.svg') }}" class="h-5 w-5 mx-1">
                            <span id="coins-post-{{ post.id }}" class="mr-1 hover:text-gray-900 dark:hover:text-gray-100">{{ post.coins }}</span>
                        </p>
                        <button class="rounded-full px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 hover:text-gray-900 dark:hover:text-gray-100 text-sm mr-3 flex"
                            onclick="
                                coin({{ post.id }}, 1)
                            "
                        >+1</button>
                        <button class="rounded-full px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 hover:text-gray-900 dark:hover:text-gray-100 text-sm mr-3 flex"
                            onclick="
                                coin({{ post.id }}, 2)
                            "
                        >+2</button>
                    {% else -%}
                        <p class="rounded-sm px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-600 text-blue-500 dark:text-blue-300 text-sm mr-3 flex">
                            <img src="{{ url_for('static', filename='svg/pi-activated.svg') }}" class="h-5 w-5 mx-1">
                            {{ post.coins }}
                        </p>
                    {%- endif %}
                {%- endif %}
            </div>
            {% if post.author != current_user -%}
                {% if not current_user.is_collecting(post) -%}
                    <a class="btn-inactivated" href="{{ url_for('main.collect_post', id=post.id) }}">
                        <i class="bi-star"></i>
                        {{ _("Collect") }}
                        {{ post.collectors | length }}
                    </a>
                {% else -%}
                    <a class="btn-activated" href="{{ url_for('main.uncollect_post', id=post.id) }}" style="background-color: var(--orange);">
                        <i class="bi-star-fill"></i>
                        {{ _("Uncollect") }}
                        {{ post.collectors | length }}
                    </a>
                {%- endif %}
            {%- endif %}
            {% if post.author == current_user
                  and can_edit -%}
                <a class="btn-inactivated ml-1" href="{{ url_for('main.edit_post', id=post.id) }}">
                    <i class="bi-pencil-square"></i>&nbsp;
                    {{ _("Edit") }}
                </a>
            {%- endif %}
            {% if post.author == current_user
                and can_delete -%}
                <form class="form-inline" method="POST" action="{{ url_for('main.delete_post', id=post.id) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn-inactivated ml-1" onclick="return confirm('{{ _('Are you sure?') }}');">
                        <i class="bi-trash"></i>&nbsp;
                        {{ _("DELETE") }}
                    </button>
                </form>
            {%- endif %}
        </div>
    {%- endif %}
{% endmacro %}

{% macro avatar(user, class="", style="", size=40) %} {# Style must be nothing or end with ";" #}
    <div style="
        width: {{ size + size // 5 }}px !important;
        height: {{ size + size // 5 }}px !important;
        padding: {{ size // 10 }}px;
        border-radius: {{ size // 2 + size // 10 }}px;
        margin: 0 !important;
        {{ user.load_avatar_style(size + size // 5) }}
    ">
        <img
            src="{{ user.avatar_url() }}"
            style="
                width: {{ size }}px !important;
                height: {{ size }}px !important;
                border-radius: {{ size // 2 }}px;
                {{ style }}
            "
            data-href="{{ url_for('ajax.get_profile', user_id=user.id) }}"
            alt="identicon"
        >
    </div>
{% endmacro %}

{% macro username(user, class="", style="", size="100%", link=True, badge=True, bold=False) %} {# Style must be nothing or end with ";" #}
    {% if user.is_authenticated %}
        {% if link %}
            <a style="font-size: {{ size }}; text-decoration: none; margin-left: .5em;{{ style }}
                {{ user.load_username_style() }}
                margin-bottom: 0 !important;"
                href="{{ url_for('user.profile', username=user.username) }}"
                class="{{ class }}"
            >{{ user.username }}</a>
        {% else %}
            <span style="font-size: {{ size }}; text-decoration: none; margin-left: .5em;{{ style }}
                {{ user.load_username_style() }}
                margin-bottom: 0 !important;"
                class="{{ class }}"
            >{{ user.username }}</span>
        {% endif %}
        {% if badge %}
            {{ level_badge(user) }}
        {% endif %}
    {% endif %}
{% endmacro %}

{% macro avatar_username(user, avatar_size=30, username_size="100%", badge=True, link=True, style="", class="", bold=False) %}
    <div class="d-flex align-items-center">
        {{ avatar(user, size=avatar_size) }}
        {{ username(user, size=username_size, badge=badge, link=link, style=style, class=class) }}
    </div>
{% endmacro %}

{% macro user_card(user, group=None) %}
    <li class="list-group-item d-flex">
        {{ avatar_username(user, avatar_size=40, username_size="150%") }}
        {% if group and current_user == group.manager -%}
            <div class="align-items-end flex-column ml-auto">
            <form class="form-inline" method="GET" action="{{ url_for('group.set_manager', user_id=user.id, group_id=group.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-warning flex-fill">
                    <i class="bi-kanban"></i>SET AS MANAGER
                </button>
            </form>
            {% if user != current_user %}
            <form class="form-inline" method="POST" action="{{ url_for('group.kick_out', user_id=user.id, group_id=group.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-outline-danger flex-fill" onclick="return confirm('{{ _('Are you sure?') }}');">
                    <i class="bi-person-x"></i>KICK OUT
                </button>
            </form>
            {% endif %}
            </div>
        {% endif %}
    </span>
    </li>
{% endmacro %}

{% macro post_card(post, no_author=False) %}
    <div class="list-group-item post-card rounded-md m-3 p-3">
        {% if not no_author %}
            {% if post.author %}
                <div class="flex">
                    {{ avatar(post.author, size=24) }}&nbsp;<a class="text-gray-900 dark:text-gray-100" href="{{ post.author.profile_url() }}"><b>{{ post.author.username }}</b></a>&nbsp;&nbsp;·&nbsp;&nbsp;{{ render_timestamp(post.timestamp) }}
                </div>
            {% else %}
                {{ _("Deleted Flog User") }} · {{ render_timestamp(post.timestamp) }}
            {% endif %}
        {% endif %}
        <h4 class="mt-2">
            <a class="text-gray-900 dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300" href="{{ post.url() }}" title="{{ post.title }} {% if post.private %}({{ _('Private') }}){% endif %}">
                <b>{% if post.private %}<i class="bi-eye-slash-fill"></i>&nbsp;&nbsp;&nbsp;{% endif %}
                {{ post.title }}</b>
            </a>
        </h4>
        <div class="post-container">
            {% if post.author.username == post.title %}
                <span class="text-yellow-400 text-sm">
                    <i class="bi bi-star-fill"></i>&nbsp;Description
                </span>
            {% endif %}
            <div class="post-content text-sm">{{ post.content | striptags | truncate(220) }}</div>
        </div>
        <hr class="mt-2 mb-1" />
        <div>
            {% if post.columns %}
                <p class="text-sm mt-1 text-gray-600 dark:text-gray-400">
                    {{ _("This post belongs to") }}
                    {% for column in post.columns[:-1] %}
                        <a href="{{ url_for('main.view_column', id=column.id) }}">
                            {{ _("Column") }} 「{{ column.name }}」
                        </a>,
                    {% endfor %}
                    {% if post.columns | length > 1 %} {{ _("and") }}{% endif %}
                    <a href="{{ url_for('main.view_column', id=post.columns[-1].id) }}">
                        {{ _("Column") }} 「{{ post.columns[-1].name }}」
                    </a>.
                </p>
            {% endif %}
            {{ post_actions(post) }}
        </div>
    </div>
{% endmacro %}

{% macro post_card_js() %}
    {# javascript #}
    {# Notice: Post content may not be truncated, but it must be processed with HTML tags. #}
        function post_card(post_id, title, author, avatar, avatar_style, fromnow, content, columns, coins, private=false) {
            if (avatar == "") {
                let avatar_elem = ""
            } else {
                avatar_elem = (
                    '<div style="width: 28px !important; height: 28px !important; padding: 2px; border-radius: 14px; margin: 0 !important; ' +
                    avatar_style + '"><img src="' + avatar + '" style="width: 24px !important; height: 24px !important; border-radius: 12px;">' +
                    '</div>'
                )
            }
            let author_name = (author == "") ? '{{ _("Deleted Flog User") }}' : author
            let coined_posts = [
                {% for post in current_user.coined_posts %}
                    {{ post.id }},
                {% endfor %}
            ]
            let collections = [
                {% for post in current_user.collections %}
                    {{ post.id }},
                {% endfor %}
            ]
            string = (
                '<div class="list-group-item bg-white dark:bg-gray-700 rounded-md m-3 p-3">\n' +
                '<div class="flex">' + avatar_elem + '&nbsp;&nbsp;<a href="/user/' + author_name + '/"><b>' + author_name + '</b></a><p>&nbsp;·&nbsp;{{ _("posted at ") }}' + fromnow + '</p></div>\n' +
                '<h4 class="mt-2">' + '<a class="text-gray-900 dark:text-gray-100 hover:text-gray-700 dark:hover:text-gray-300" href="/post/' + post_id +
                '/" title="' + title + (private ? "({{ _('Private') }})" : "") + '"><b>' + (private ? '<i class="bi-eye-slash-fill"></i>&nbsp;&nbsp;&nbsp;' : "") + title + '</b></a></h4>\n' +
                '<div class="post-container">' + ((author_name == title) ? '<span class="text-yellow-400 text-sm"><i class="bi bi-star-fill"></i>&nbsp;Description</span>' : "") +
                '<div class="post-content text-sm">' +content + '</div>' + '</div><hr class="m-1" />'
            )
            if (columns.length > 0) {
                string += '<p class="text-sm mt-1 text-gray-600 dark:text-gray-400">{{ _("This post belongs to") }}'
                for (c in columns.slice(0, columns.length - 1)) {
                    string += (
                        '<a href="/column/{{ _("Column") }}/">「' + column.name + '」</a>,'
                    )
                }
                if (columns.length > 1) string += '{{ _("and") }}'
                string += '<a href="/column/{{ _("Column") }}/">「' + columns[columns.length - 1] + '」</a>.</p>'
            }
            {% if current_user.is_authenticated %}
                string += (
                        '<div class="flex justify-start items-center my-2">' +
                            '<div id="btn-post-' + post_id + '" class="flex bg-gray-100 dark:bg-gray-600 py-1 px-2 rounded-md"' +
                                'style="' +
                                    'transition: width 2s !important;' +
                                    '-webkit-transition: width 2s !important;' +
                                    '-moz-transition: width 2s !important;' +
                                    '-o-transition: width 2s !important;">'
                )
                if (author_name == "{{ current_user.username }}") {
                    string += (
                        '<p class="rounded-sm px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-900 dark:text-gray-100 text-sm mr-3 flex" href="javascript:void(0)">' +
                            '<img src="{{ url_for('static', filename='svg/pi.svg') }}" class="h-5 w-5 mx-1">' +
                            post.coins +
                        "</p>"
                    )
                    {% if not current_user.locked %}
                        '<a class="btn-inactivated ml-1" href="/post/edit/' + post_id + '/">' +
                            '<i class="bi-pencil-square"></i>&nbsp;' +
                            '{{ _("Edit") }}' +
                        '</a>'
                        '<form class="form-inline" method="POST" action="/post/delete/' + post_id + '/">'+
                            '<input type="hidden" name="csrf_token" value="{{ csrf_token() }}">'+
                            '<button class="btn-inactivated ml-1" onclick="return confirm(\'{{ _('Are you sure?') }}\');">'+
                                '<i class="bi-trash"></i>&nbsp;'+
                                '{{ _("DELETE") }}'+
                            '</button>'+
                        '</form>'
                    {% endif %}
                } else {
                    if (coined_posts.indexOf(post_id) == -1) {
                        string += (
                            '<p class="rounded-sm px-2 py-1 text-gray-900 dark:text-gray-100 hover:text-gray-900 dark:hover:text-gray-100 text-sm mr-3 flex">'+
                                '<img src="{{ url_for('static', filename='svg/pi.svg') }}" class="h-5 w-5 mx-1">' +
                                '<span id="coins-post-' + post_id + '" class="mr-1 hover:text-gray-900 dark:hover:text-gray-100">' + coins + '</span>' +
                            '</p>' +
                            '<button class="rounded-full px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 hover:text-gray-900 dark:hover:text-gray-100 text-sm mr-3 flex"' +
                                'onclick="' +
                                    'coin(' + post_id + ', 1)">+1</button>' +
                            '<button class="rounded-full px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-500 text-gray-900 dark:text-gray-100 hover:text-gray-900 dark:hover:text-gray-100 text-sm mr-3 flex"' +
                                'onclick="' +
                                    'coin(' + post_id + ', 2)">+2</button>'
                        )
                    } else {
                        string += (
                            '<p class="rounded-sm px-2 py-1 hover:bg-gray-300 dark:hover:bg-gray-600 text-blue-500 dark:text-blue-300 text-sm mr-3 flex">' +
                                '<img src="{{ url_for('static', filename='svg/pi-activated.svg') }}" class="h-5 w-5 mx-1">' +
                                coins +
                            '</p>'
                        )
                    }
                    string += "</div>"
                    if (collections.indexOf(post_id) == -1) {
                        string += ('<div id="div-collect-' + post_id + '"><a class="btn-inactivated" id="btn-collect-' + post_id + '" href="javascript:collect(' + post_id + ')">' +
                            '<i class="bi-star"></i>' +
                            '&nbsp;{{ _("Collect") }}' +
                        '</a></div>')
                    } else {
                        string += ('<div id="div-collect-' + post_id + '"><a class="btn-activated" id="btn-collect-' + post_id + '" href="javascript:uncollect(' + post_id + ')">' +
                            '<i class="bi-star-fill"></i>' +
                            '&nbsp;{{ _("Uncollect") }}' +
                        '</a></div>')
                    }
                }
            {% endif %}
            $("#post-container").append(string)
        }
{% endmacro %}

{% macro post_container() %}
    <div id="post-container"></div>
{% endmacro %}

{% macro group_card(group) %}
    <li class="list-group-item">
        <h3>{{ _("Group name:" ) }} {{ group.name }}
            {% if group.private %}
                <span class="badge badge-dark">
                    {{ _("Private") }}
                </span>
            {% endif %}
        </h3>
        <h4>{{ _("Manager: ") }}
            <a href="{{ group.manager.profile_url() }}"
               class="text-muted profile-popover"
               data-href="{{ url_for('ajax.get_profile', user_id=group.manager.id) }}">
                {{ group.manager.username }}
            </a>
        </h4>
        <h4>
            <i class="bi-info"></i>
            <a href="{{ url_for('group.info', id=group.id) }}">
                {{ _("Group Info") }}
            </a>
        </h4>
    </li>
{% endmacro %}

{% macro column_card(column, extra_classes="") %}
    <li class="list-group-item {{ extra_classes }}">
        <h3>{{ _("Column name:") }} <a href="{{ url_for('main.view_column', id=column.id) }}">{{ column.name }}</a></h3>
        <h4>
            {{ avatar_username(column.author, avatar_size=30, username_size="100%", badge=False) }}
        </h4>
        <h4>
            {{ _("Created") }} {{ moment(column.timestamp).fromNow(refresh=True) }}
    </h4>
    </li>
{% endmacro %}

{% macro message_card(message) %}
    {% set user = message.author %}
    <div class="message-card">
        <div class="d-flex justify-content-center">
            <p class="text-muted">
                <small>{{ moment(message.timestamp).format('LLL') }}</small>
            </p>
        </div>
        {% if message.author == current_user %}
            <div class="d-flex justify-content-end mb-3">
                <span class="bg-success message-body self">
                    {{ message.body }}
                </span>
                <a href="{{ url_for('user.profile', username=user.username) }}">
                    <img src="{{ user.avatar_url() }}" class="profile-popover"
                         data-href="{{ url_for('ajax.get_profile', user_id=user.id) }}">
                </a>
            </div>
        {% else %}
            <div class="d-flex justify-content-start" style="margin-bottom: 10px">
                <a href="{{ url_for('user.profile', username=user.username) }}">
                    <img src="{{ user.avatar_url() }}" class="profile-popover" alt="{{ user.username }}"
                         data-href="{{ url_for('ajax.get_profile', user_id=user.id) }}" height="30px" width="auto">
                </a>
                <span class="bg-light message-body others">
                    {{ message.body }}
                </span>
            </div>
        {% endif %}
    </div>
{% endmacro %}

{% macro action_card(icon, text, link) %}
    <a class="dropdown-item" href="{{ link }}">
        <i class="{{ icon }}"></i>&nbsp;&nbsp;{{ text }}
    </a>
{% endmacro %}

{% macro load_ckeditor() %}
    {{ ckeditor.load() }}
    {{ ckeditor.config(name="content") }}
    {{ ckeditor.config(custom_config="extraAllowedContent: '"+allowed_tags+"'") }}
{% endmacro %}

{% macro shop_card(user, id, goods) %}
    <li class="list-group-item d-flex">
        <div class="d-flex align-items-center">
            <div style="
                width: 44px !important;
                height: 44px !important;
                padding: 4px;
                border-radius: 22px;
                {{ goods[id].style }}
            ">
                <img
                    src="{{ user.avatar_url() }}"
                    style="
                        width: 36px !important;
                        height: 36px !important;
                        border-radius: 18px;
                    "
                    data-href="{{ url_for('ajax.get_profile', user_id=user.id) }}"
                    alt="identicon"
                >
            </div>
            <h3 style="{{ goods[id].text_style }}">
                <strong>&nbsp;&nbsp;&nbsp;{{ goods[id]["name"] }}</strong>
            </h3>
        </div>
        <span class="text-white align-items-end flex-column ml-auto">
            {% if id not in user.load_belongings_id() %}
                {% if goods[id].expires.__str__()[:2] != "99" %}
                    {% if goods[id].price != 0 %}
                        <span class="
                            {% if user.coins>=goods[id].price %}
                                text-success
                            {% else %}
                                text-danger
                            {% endif %}
                        ">({{ user.coins.__float__() }} / {{ goods[id].price.__float__() }})</span>
                    {% endif %}
                    <span class="text-muted">
                    {% if goods[id].price == 0 %}
                        free
                    {% else %}
                        {{ goods[id].price }}pi
                    {% endif %}
                    / {{ goods[id].expires.__str__()[:7] }}</span>
                {% else %}
                    {% if goods[id].price != 0 %}
                        <span class="
                            {% if user.coins>=goods[id].price %}
                                text-success
                            {% else %}
                                text-danger
                            {% endif %}
                        ">({{ user.coins.__float__() }} / {{ goods[id].price.__float__() }})</span>
                    {% endif %}
                    <span class="text-muted">
                    {% if goods[id].price == 0 %}
                        free
                    {% else %}
                        {{ goods[id].price.__float__() }}pi
                    {% endif %}
                    for lifetime</span>
                {% endif %}
                <br><span class="text-muted">
                    <span class="
                        {% if user.experience>=goods[id].exp %}
                            text-primary
                        {% else %}
                            text-warning
                        {% endif %}
                    ">({{ user.experience }} / {{ goods[id].exp }})</span>&nbsp;Required Exp: {{ goods[id].exp }}&nbsp;&nbsp;&nbsp;&nbsp;</span>
                <a class="btn btn-sm btn-primary flex-fill
                    {% if user.coins < goods[id].price or user.experience < goods[id].exp %}
                        disabled
                    {% endif %}
                "
                    href="{{ url_for('shop.buy', id=id) }}">
                    <b>Buy</b>
                </a>
            {% elif id == user.avatar_style_id %}
                <a class="btn btn-sm btn-success flex-fill disabled">
                    <b>In Use</b>
                </a>
            {% else %}
                <a class="btn btn-sm btn-success flex-fill"
                    href="{{ url_for('shop.use', id=id) }}">
                    <b>Use</b>
                </a>
            {% endif %}
        </span>
    </li>
{% endmacro %}

{% macro stats_card(name, value) %}
    <tr>
        <td>{{ name }}</td><td>{{ value }}</td>
    </tr>
{% endmacro %}

{% macro login_form() %}
    <form class="mt-8 space-y-6" action="/auth/login/" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <div class="rounded-md p-3 m-auto mt-3">
            <div class="mb-3">
                <label for="user" class="sr-only">{{ _("Username / Email") }}</label>
                <input id="user" name="user" type="text" required class="relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-600 focus:border-indigo-600 bg-transparent" placeholder="{{ _('Username / Email') }}">
            </div>
            <div>
                <label for="password" class="sr-only">{{ _("Password") }}</label>
                <input id="password" name="password" type="password" autocomplete="current-password" required class="relative block w-full px-3 py-2 border border-gray-300 dark:border-gray-700 placeholder-gray-500 text-gray-900 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-600 focus:border-indigo-600 bg-transparent" placeholder="{{ _('Password') }}">
            </div>
        </div>

        <div class="text-sm mx-3 mt-1 mb-2">
            <a href="#" class="font-medium"> Forgot your password? </a>
        </div>

        <div>
        <button type="submit" class="group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mr-3">
            <span class="absolute left-0 inset-y-0 flex items-center pl-3">
                <svg class="h-5 w-5 text-indigo-800 group-hover:text-indigo-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                </svg>
            </span>
            Sign in
        </button>
        </div>
    </form>
{% endmacro %}